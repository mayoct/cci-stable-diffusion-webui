version: 2.1

orbs:
  python: circleci/python@2.1.1

workflows:
  Tests:
    jobs:
      - test

jobs:
  test:
    machine:
      image: ubuntu-2204:current
    resource_class: large
    steps:
      - checkout
      - run:
          name: Set up Python 3.10
          command: |
            pyenv install 3.10.6
            pyenv global 3.10.6
      - python/install-packages:
          args: wait-for-it
          pkg-manager: pip
          pip-dependency-file: requirements-test.txt
      - run:
          name: Setup environment
          command: python launch.py --skip-torch-cuda-test --exit
          environment:
            PIP_DISABLE_PIP_VERSION_CHECK: "1"
            PIP_PROGRESS_BAR: "off"
            TORCH_INDEX_URL: https://download.pytorch.org/whl/cpu
            WEBUI_LAUNCH_LIVE_OUTPUT: "1"
            PYTHONUNBUFFERED: "1"
      - run:
          name: Start test server
          command: >
            python -m coverage run
            --data-file=.coverage.server
            launch.py
            --skip-prepare-environment
            --skip-torch-cuda-test
            --test-server
            --do-not-download-clip
            --no-half
            --disable-opt-split-attention
            --use-cpu all
            --api-server-stop
            2>&1 | tee output.txt &                     